<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SWF Player</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      background-color: #000;
      overflow: hidden;
    }
    #container {
      width: 100%;
      height: 100%;
    }
    ruffle-player {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
<script src="dd0be85ee9c2092132d1.wasm.js"></script>
<script src="c1c1a8b2293497a31e49.wasm.js"></script>
<script src="ruffle.js"></script>
<script>
function dataURLtoBlobURL(dataURL){
  try {
    var byteString = atob(dataURL.split(',')[1]);
    var mime = dataURL.split(',')[0].split(':')[1].split(';')[0];
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (i = 0; i < byteString.length; i++){
      ia[i] = byteString.charCodeAt(i);
    }
    var blob = new Blob([ab], { type: mime });
    return URL.createObjectURL(blob);
  } catch (error) {
    alert('Failed to convert data URL to Blob URL');
    console.error('Failed to convert data URL to Blob URL:', error);
  }
}

const urlParams = new URLSearchParams(window.location.search);
const channel = (urlParams.get('channel') || null);
const file = urlParams.get('file');

if (channel) {
  document.title = channel;
  const bc = new BroadcastChannel(channel);
  
  bc.onmessage = (event) => {
    if (event.data.type === 'swf') {
      var dataURL = event.data.data;
      var blobURL = dataURLtoBlobURL(dataURL);
      loadSWF(blobURL);
      bc.postMessage({ type: 'close' });
      bc.close();
    }
  };
} else if (file) {
  loadSWF(file);
} else {
  console.error('No file or channel provided');
}

function loadSWF(url) {
  const rufflePlayer = window.RufflePlayer.newest();
  const container = document.createElement('div');
  container.id = 'container';
  container.style.width = '100%';
  container.style.height = '100%';
  document.body.appendChild(container);

  const player = rufflePlayer.createPlayer();
  player.style.width = '100%';
  player.style.height = '100%';
  container.appendChild(player);
  player.load(url);
}
</script>
</body>
</html>
